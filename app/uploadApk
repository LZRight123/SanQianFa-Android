#!/bin/sh

#æˆ‘çš„ç»ˆç«¯è«è®¤ç¿»å¢™ å…ˆå…³æ‰
unset http_proxy;
unset https_proxy;
echo "å·²å…³é—­ä»£ç†";
script_dir=$(cd $(dirname $0);pwd)
# projectDirectory=$(dirname $script_dir)
# echo "è„šæœ¬ç›®å½•=${script_dir}"
# echo "å·¥ç¨‹ç›®å½•=${projectDirectory}"
type=$1
echo "type: ${type}"
echo "ğŸ’ŠğŸ‘ŒğŸ’ğŸ‚ğŸ‘ğŸ¿ğŸŒ¹â¬†ï¸ãŠ™ï¸ğŸ±ğŸ©ğŸ‚ğŸ²âœˆï¸ğŸ‘€ğŸš€ğŸ”¥ğŸ®ğŸ’•ğŸ†ğŸ ğŸ’¯ ğŸŒ¹"


function callPublishVersion() {
    echo "æ‰æˆ‘ä»¬çš„å‘ç‰ˆæ¥å£ â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸  â¬†ï¸"
    downloadKey="public/apks/${type}/${apk_name}"
    downloadUrl="https://files-static.naduo.love/${downloadKey}"
    if [ "$type" = "release" ]; then
        update_env="ç”Ÿäº§"
        baseUrl="https://bellybook-app-api.bellybook.cn"
    else
        update_env="æµ‹è¯•"
        baseUrl="https://staging-bellybook-app-api.bellybook.cn"
    fi
    echo "ç¯å¢ƒ $update_env"
    # æ‰æˆ‘ä»¬çš„å‘ç‰ˆæ¥å£
    curl -X POST "${baseUrl}/api/v1/web/version/publish_version" \
    -H 'Content-Type: application/json' \
    -d '{
        "channel": "android",
        "version_name":"'"${version_name}"'",
        "version_number":"'"${version_code}"'",
        "force_update":false,
        "release_notes": ["æœºå™¨äººå‘ç‰ˆæœ¬ã€‚"]
    }'
    echo "\næŸ¥çœ‹ä¸€ä¸‹ç»“æœ ${baseUrl}/api/v1/public/get_app_version_info"
#    curl -X GET "${baseUrl}/api/v1/public/get_app_version_info"
}

function upload(){
    ossShell=~/opt/ossutilmac64
    bucket_name="bellybook-oss"

    apk_dir="${script_dir}/build/outputs/apk"
#    universal_apk_dir="${apk_dir}/universal/$type"
    universal_apk_dir="${apk_dir}/$type"
    apk_path=$(find ${universal_apk_dir} -name "*.apk")
    apk_name=${apk_path##*/}
    version_name=$(echo $apk_name | sed 's/^v//;s/_.*//')
    version_code=$(grep VERSION_CODE version.properties | cut -d'=' -f2)


    echo "universal_apk_dir: ${universal_apk_dir}"
    echo "apk_name: ${apk_name}"
    echo "ç‰ˆæœ¬å·: ${version_name}(Build ${version_code})"

    # æœ¬åœ°æ–‡ä»¶è·¯å¾„
    # æµ‹è¯•åªéœ€ä¼ é€šç”¨åŒ…
    universal_file_path=$universal_apk_dir/$apk_name
    oss_apk_dir="oss://$bucket_name/apk/$type"

    if [ "$type" = "release" ]; then
        # æ­£å¼ç¯å¢ƒä¸Šä¼ æµç¨‹
        # 1. ä¸Šä¼ é€šç”¨åŒ…
        universal_remote_file_path="$oss_apk_dir/histroy/$apk_name"
        echo "æ­£å¼ç¯å¢ƒä¸Šä¼  OSS local apk: ${universal_file_path} åˆ° ${universal_remote_file_path}"
        $ossShell cp -f $universal_file_path $universal_remote_file_path
        # 2. å°†é€šç”¨åŒ…é‡å‘½åä¸º bellbook.apk å¹¶ä¸Šä¼ è‡³æ ¹ç›®å½•, éƒ¨ç½²åœ¨è‡ªå·±æœåŠ¡å™¨
        $ossShell cp -f $universal_remote_file_path "$oss_apk_dir/template.apk"
    else
        # æµ‹è¯•ç¯å¢ƒä¸Šä¼ æµç¨‹
        # 1. ä¸Šä¼ é€šç”¨åŒ…è‡³æ ¹ç›®å½• bellbook.apk
        universal_remote_file_path="$oss_apk_dir/template.apk"
        echo "æµ‹è¯•ç¯å¢ƒä¸Šä¼  OSS local apk: ${universal_file_path} åˆ° ${universal_remote_file_path}"
        $ossShell cp -f $universal_file_path $universal_remote_file_path
    fi

#    # 3. ä¸Šä¼  google åŒ…
#    google_file_path="$apk_dir/google/$type/$apk_name"
#    google_remote_file_path="$oss_apk_dir/google/$apk_name"
#    $ossShell cp -f $google_file_path $google_remote_file_path
#    # 4. ä¸Šä¼  china åŒ… é’ˆå¯¹ä¸­å›½é•œå†…åº”ç”¨å¸‚åœº
#    china_file_path="$apk_dir/china/$type/$apk_name"
#    china_remote_file_path="$oss_apk_dir/china/$apk_name"
#    $ossShell cp -f $china_file_path $china_remote_file_path
}

function webhook() {
    if [ "$type" = "release" ]; then
        update_env="ç”Ÿäº§"
    else
        update_env="æµ‹è¯•"
    fi
    updatetime=`date +'%Y-%m-%d %H:%M:%S'`
    # æ›´æ–°å†…å®¹
    update_description="- å›å¿†æ¨¡å—é‡æ„\n- åˆ›å»ºäº‘æœµç²¾ç®€"
    curl -X POST -H "Content-Type: application/json" \
	-d '{
	"msg_type": "post",
	"content": {
		"post": {
			"zh_cn": {
				"title": "App æ›´æ–°é€šçŸ¥",
				"content": [
                    [{"tag": "text","text": "æ‚¨çš„åº”ç”¨ä¸Šä¼ äº†æ–°ç‰ˆæœ¬"}],
                    [{"tag": "text","text": "åº”ç”¨åç§°ï¼šé‚£æœµ('"${update_env}"')"}],
                    [{"tag": "text","text": "åº”ç”¨ç±»å‹ï¼šAndroid"}],
                    [{"tag": "text","text": "ç‰ˆæœ¬ä¿¡æ¯ï¼š'"${version_name}"'(Build '"${version_code}"')"}],
                    [{"tag": "text","text": "æ›´æ–°æ—¶é—´ï¼š'"${updatetime}"'"}],
                    [{"tag": "text","text": "æ›´æ–°å†…å®¹ï¼š'"${update_description}"'"}],
                    [{"tag": "text","text": "ç‰ˆæœ¬æŸ¥è¯¢ï¼š'"${baseUrl}"'/naduo/api/version/getVersion?platform=android"}],

					[
						{
							"tag": "a",
							"text": "ç‚¹é“¾æ¥æŸ¥çœ‹æ›´æ–°",
							"href": "https://naduo.love"
						},
						{
							"tag": "at",
							"user_id": "all",
                            "user_name": "æ‰€æœ‰äºº"
						}
				    ]
                ]
			}
		}
	}
    }' \
    https://open.feishu.cn/open-apis/bot/v2/hook/ef329f6f-c9c5-4d59-91d1-a9c199ab1cdd

    # å°ç¾¤-ç ”ç©¶æœºå™¨äººçš„
    # https://open.feishu.cn/open-apis/bot/v2/hook/902307e8-cb6f-4e9c-b2d9-7525161bac56
    # å¤§ç¾¤
    # https://open.feishu.cn/open-apis/bot/v2/hook/ef329f6f-c9c5-4d59-91d1-a9c199ab1cdd

}

function start()
{
    starttime=`date +'%Y-%m-%d %H:%M:%S'`
    echo "ä¸Šä¼ å¼€å§‹æ—¶é—´ : " ${starttime}
    upload
    if [ "$type" = "release" ]; then
        echo "æ­£å¼ æ‰‹åŠ¨æ‰ç”¨å‘ç‰ˆæ¥å£"
    else
        echo "æµ‹è¯• è‡ªåŠ¨æ‰ç”¨å‘ç‰ˆæ¥å£"
#        callPublishVersion
#        webhook
    fi


    endtime=`date +'%Y-%m-%d %H:%M:%S'`
    echo "ç»“æŸæ—¶é—´ : " ${endtime}
    echo "æ‚¨æœ‰ä¸€ä¸ªæ–°çš„Appç‰ˆæœ¬ï¼Œè¯·åŠæ—¶æ›´æ–°ğŸ‘Œ ğŸ”¥ ğŸ‘Œ ğŸ”¥ ğŸ’¯ ğŸ”¥ ğŸ’¯ ğŸ”¥ ğŸ’¯ ğŸ”¥ ğŸ’¯ ğŸ‘Œ ğŸ”¥ ğŸ‘Œ ğŸ”¥ ğŸ’¯ ğŸ”¥ ğŸ’¯ ğŸ”¥ ğŸ’¯ ğŸ”¥ ğŸ’¯ ğŸ”¥ ğŸ’¯ ğŸ”¥ ğŸ’¯ ğŸ”¥"
}

start
# upload
